# Задание 11

## Условие

При старте программы должно быть создано в дополнение к существующему основному потоку
ещё три дополнительных. Дадим им условные имена:
- main – основной поток (в пользовательском приложении)
- log – поток для вывода данных в консоль
- file1 – первый поток для вывода в файл
- file2 – второй поток для вывода в файл
Основная логика обработки меняется таким образом, что блок команд после своего формирования
должен быть отправлен в консоль (потоком log) и сразу в файл (одним из потоков file1 или file2).
При этом отправка блока в файл распределяется между файловыми потоками.
Можно напрямую отправлять, например, чётные команды через поток file1, а нечётные – через
file2. Но лучшим решение станет использование единой очереди команд, которую будут
обрабатывать оба файловых потока одновременно.
Следует обратить внимание на недостаточную точность часов для формирования уникального
имени. Необходимо, сохранив timestamp в имени, добавить дополнительный постфикс, который
будет гарантированно отличаться у файловых потоков.


Основная цель переработать Задание 7 так, чтобы ввод данных контролировался внешним кодом. Интерфейс описан в файле `async.h`. Инициатором обмена будет выступать внешний код, вместо привычной входной точки `main()` будет три - `connect()`, `receive()` и `disconnect()`.

Порядок вызова следующий:

- Вызывается `connect()` с размером блока команд. Сохраняется значение возврата. Значение никак не интерпретируется и служит только для передачи контекста;
- Вызывается `receive()` с передачей указателя на начало буфера, размера буфера и контекста. Вызов повторяемый;
- Вызывается `disconnect()` с передачей контекста. Вызов разрушает контекст.

Необходимо реализовать эти функции так, чтобы сохранить прежнюю функциональность проекта и добавить новую возможность.

Реализация должна допускать множественные вызовы `connect()`. Вызовы `receive()` с разными контекстами не должны мешать друг другу.

В зависимости от внутренней реализации может возникнуть требование иметь одинаковый размер блока для всех команд. Нет цели вносить столь глубокие изменения. Если потенциальная возможность иметь разные размеры очереди влечет глубокую переработку, функция `connect()` должна вернуть `nullptr`.

Вызовы могут осуществляться из разных потоков, однако вызовы с одинаковым контекстом выполняются из одного и того же потока.

Опционально реализовать возможность вызывать все функции из любых потоков.

Опционально взять за основу вместо однопоточной версии из Задания 7 многопоточную реализацию из Задания 10.

## Требования к реализации

Результатом работы должна стать библиотека устанавливаемая по стандартному пути. Библиотека должна называться `libasync.so` и находиться в пакете `async`.

Результат работы должен быть опубликован на bintray.

## Проверка

Задание считается выполненным успешно, если после установки пакета, линковки с тестовым кодом (пример в `main.cpp`) и запуска с тестовыми данными вывод соответствует описанию Задания 7. Данные подаются порциями в разных контекстах в большом объеме без пауз.

Будет отмечено отсутствие ограничений на вызов из разных потоков и взятая за основу многопоточная версия задания.

## Самоконтроль

* файл `async.h` должен остаться без изменений